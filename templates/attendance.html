<!-- templates/attendance.html -->
{% extends 'base.html' %}

{% block title %}ì¶œì„ì²´í¬ - {{ class.className }}{% endblock %}

{% block content %}
<!-- ë„¤ë¹„ê²Œì´ì…˜ -->
<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{% url 'meeting_app:classes' %}">ëª¨ì„</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{% url 'meeting_app:post_list' class.classID %}">{{ class.className }}</a>
                </li>
                <li class="breadcrumb-item active">ì¶œì„ì²´í¬</li>
            </ol>
        </nav>
    </div>
</div>

<!-- ëª¨ì„ ì •ë³´ í—¤ë” -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-2">
                            <i class="fas fa-calendar-check"></i> {{ class.className }} ì¶œì„ì²´í¬
                        </h4>
                        <p class="text-muted mb-0">
                            <i class="fas fa-tag"></i> {{ class.interestID.interestName }}
                            <span class="ms-3">
                                <i class="fas fa-calendar"></i> {{ class.classStartDate }} ~ {{ class.classEndDate }}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="btn-group" role="group">
                            <a href="{% url 'meeting_app:post_list' class.classID %}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-arrow-left"></i> ê²Œì‹œíŒìœ¼ë¡œ
                            </a>
                            <a href="{% url 'meeting_app:classes' %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-search"></i> ëª¨ì„ ëª©ë¡
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì¶œì„ì²´í¬ í¼ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users"></i> ìˆ˜ê°•ìƒ ì¶œì„ì²´í¬
                    <span class="badge bg-primary ms-2">{{ ìˆ˜ê°•ìƒë“¤|length }}ëª…</span>
                </h5>
            </div>
            <div class="card-body">
                {% if ìˆ˜ê°•ìƒë“¤ %}
                <form method="post" id="attendanceForm">
                    {% csrf_token %}
                    
                    <!-- ì¶œì„ì¼ ì„ íƒ -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="form-floating">
                                <input type="date" class="form-control" id="attendanceDate" name="date" 
                                       value="{% now 'Y-m-d' %}" required>
                                <label for="attendanceDate">
                                    <i class="fas fa-calendar-alt me-2"></i>ì¶œì„ì¼
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="markAllPresent()">
                                    <i class="fas fa-check"></i> ì „ì²´ ì¶œì„
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" onclick="markAllLate()">
                                    <i class="fas fa-clock"></i> ì „ì²´ ì§€ê°
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="markAllAbsent()">
                                    <i class="fas fa-times"></i> ì „ì²´ ê²°ì„
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ìˆ˜ê°•ìƒ ëª©ë¡ -->
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 5%">#</th>
                                    <th style="width: 20%">ì´ë¦„</th>
                                    <th style="width: 25%">ì—°ë½ì²˜</th>
                                    <th style="width: 25%">ì´ë©”ì¼</th>
                                    <th style="width: 25%">ì¶œì„ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ìˆ˜ê°•ìƒ in ìˆ˜ê°•ìƒë“¤ %}
                                <tr class="attendance-row" data-member-id="{{ ìˆ˜ê°•ìƒ.member_accountID.accountID }}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                {{ ìˆ˜ê°•ìƒ.member_accountID.name|first }}
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ ìˆ˜ê°•ìƒ.member_accountID.name }}</div>
                                                <small class="text-muted">{{ ìˆ˜ê°•ìƒ.member_accountID.accountType|capfirst }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <i class="fas fa-phone text-muted me-1"></i>
                                        {{ ìˆ˜ê°•ìƒ.member_accountID.phoneNum }}
                                    </td>
                                    <td>
                                        <i class="fas fa-envelope text-muted me-1"></i>
                                        {{ ìˆ˜ê°•ìƒ.member_accountID.email }}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group" data-bs-toggle="buttons">
                                            <input type="radio" class="btn-check" name="attendance_{{ ìˆ˜ê°•ìƒ.sugangID }}" 
                                                   id="present_{{ ìˆ˜ê°•ìƒ.sugangID }}" value="present">
                                            <label class="btn btn-outline-success btn-sm" for="present_{{ ìˆ˜ê°•ìƒ.sugangID }}">
                                                <i class="fas fa-check"></i> ì¶œì„
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="attendance_{{ ìˆ˜ê°•ìƒ.sugangID }}" 
                                                   id="late_{{ ìˆ˜ê°•ìƒ.sugangID }}" value="late">
                                            <label class="btn btn-outline-warning btn-sm" for="late_{{ ìˆ˜ê°•ìƒ.sugangID }}">
                                                <i class="fas fa-clock"></i> ì§€ê°
                                            </label>
                                            
                                            <input type="radio" class="btn-check" name="attendance_{{ ìˆ˜ê°•ìƒ.sugangID }}" 
                                                   id="absent_{{ ìˆ˜ê°•ìƒ.sugangID }}" value="absent">
                                            <label class="btn btn-outline-danger btn-sm" for="absent_{{ ìˆ˜ê°•ìƒ.sugangID }}">
                                                <i class="fas fa-times"></i> ê²°ì„
                                            </label>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- ì €ì¥ ë²„íŠ¼ -->
                    <div class="d-flex justify-content-between mt-4">
                        <div>
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                ì¶œì„ì¼ê³¼ ê° ìˆ˜ê°•ìƒì˜ ì¶œì„ìƒíƒœë¥¼ ì„ íƒí•œ í›„ ì €ì¥í•˜ì„¸ìš”.
                            </small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="resetForm()">
                                <i class="fas fa-undo"></i> ì´ˆê¸°í™”
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> ì¶œì„ ì €ì¥
                            </button>
                        </div>
                    </div>
                </form>
                
                {% else %}
                <!-- ìˆ˜ê°•ìƒì´ ì—†ëŠ” ê²½ìš° -->
                <div class="text-center py-5">
                    <i class="fas fa-user-slash fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">ë“±ë¡ëœ ìˆ˜ê°•ìƒì´ ì—†ìŠµë‹ˆë‹¤</h5>
                    <p class="text-muted">ë¨¼ì € ìˆ˜ê°•ìƒë“¤ì´ ëª¨ì„ì— ì°¸ì—¬í•´ì•¼ ì¶œì„ì²´í¬ë¥¼ í•  ìˆ˜ ìˆì–´ìš”.</p>
                    <a href="{% url 'meeting_app:post_list' class.classID %}" class="btn btn-primary">
                        <i class="fas fa-arrow-left"></i> ê²Œì‹œíŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- ì¶œì„ í†µê³„ (ê¸°ì¡´ ì¶œì„ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°) -->
{% if ìˆ˜ê°•ìƒë“¤ %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar"></i> ì¶œì„ í†µê³„ ì•ˆë‚´
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="stats-mini">
                            <div class="stats-number text-success">
                                <i class="fas fa-check fa-2x"></i>
                            </div>
                            <div class="text-muted small">ì¶œì„</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-mini">
                            <div class="stats-number text-warning">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                            <div class="text-muted small">ì§€ê°</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-mini">
                            <div class="stats-number text-danger">
                                <i class="fas fa-times fa-2x"></i>
                            </div>
                            <div class="text-muted small">ê²°ì„</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-mini">
                            <div class="stats-number text-primary">
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                            <div class="text-muted small">ì´ ì¸ì›</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
// ì „ì²´ ì¶œì„ ì²˜ë¦¬
function markAllPresent() {
    document.querySelectorAll('input[value="present"]').forEach(input => {
        input.checked = true;
        updateRowStyle(input.closest('tr'), 'present');
    });
}

// ì „ì²´ ì§€ê° ì²˜ë¦¬
function markAllLate() {
    document.querySelectorAll('input[value="late"]').forEach(input => {
        input.checked = true;
        updateRowStyle(input.closest('tr'), 'late');
    });
}

// ì „ì²´ ê²°ì„ ì²˜ë¦¬
function markAllAbsent() {
    document.querySelectorAll('input[value="absent"]').forEach(input => {
        input.checked = true;
        updateRowStyle(input.closest('tr'), 'absent');
    });
}

// í¼ ì´ˆê¸°í™”
function resetForm() {
    document.querySelectorAll('input[type="radio"]').forEach(input => {
        input.checked = false;
    });
    document.querySelectorAll('.attendance-row').forEach(row => {
        row.className = 'attendance-row';
    });
}

// í–‰ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
function updateRowStyle(row, status) {
    row.classList.remove('table-success', 'table-warning', 'table-danger');
    if (status === 'present') {
        row.classList.add('table-success');
    } else if (status === 'late') {
        row.classList.add('table-warning');
    } else if (status === 'absent') {
        row.classList.add('table-danger');
    }
}

// ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ ê°ì§€
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input[type="radio"]').forEach(input => {
        input.addEventListener('change', function() {
            const row = this.closest('tr');
            updateRowStyle(row, this.value);
        });
    });
    
    // í¼ ì œì¶œ ìœ íš¨ì„± ê²€ì‚¬
    document.getElementById('attendanceForm').addEventListener('submit', function(e) {
        const date = document.getElementById('attendanceDate').value;
        if (!date) {
            e.preventDefault();
            alert('ì¶œì„ì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        // ëª¨ë“  ìˆ˜ê°•ìƒì˜ ì¶œì„ìƒíƒœê°€ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
        const memberCount = {{ ìˆ˜ê°•ìƒë“¤|length }};
        const checkedCount = document.querySelectorAll('input[type="radio"]:checked').length;
        
        if (checkedCount === 0) {
            e.preventDefault();
            alert('ìµœì†Œ í•œ ëª…ì˜ ì¶œì„ìƒíƒœëŠ” ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');
            return;
        }
        
        if (checkedCount < memberCount) {
            if (!confirm(`ì¼ë¶€ ìˆ˜ê°•ìƒ(${memberCount - checkedCount}ëª…)ì˜ ì¶œì„ìƒíƒœê°€ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nê·¸ë˜ë„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                e.preventDefault();
                return;
            }
        }
    });
});

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey) {
        switch(e.key) {
            case '1':
                e.preventDefault();
                markAllPresent();
                break;
            case '2':
                e.preventDefault();
                markAllLate();
                break;
            case '3':
                e.preventDefault();
                markAllAbsent();
                break;
            case 'r':
                e.preventDefault();
                resetForm();
                break;
        }
    }
});
</script>

<style>
.avatar-sm {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #4285F4, #34A853);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 0.9rem;
}

.attendance-row {
    transition: all 0.3s ease;
}

.attendance-row:hover {
    background-color: rgba(0,0,0,0.05) !important;
}

.btn-group .btn {
    border-radius: 6px;
    margin: 0 1px;
}

.stats-mini {
    padding: 1rem;
    border-radius: 8px;
    background: #f8f9fa;
}

.table th {
    border-top: none;
    font-weight: 600;
}

.form-floating label {
    padding-left: 2.5rem;
}

.form-floating input {
    padding-left: 2.5rem;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.9rem;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        margin: 1px 0;
        border-radius: 4px;
    }
    
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
    }
}

/* ì¶œì„ìƒíƒœë³„ í–‰ ìƒ‰ìƒ */
.table-success {
    background-color: rgba(25, 135, 84, 0.1) !important;
}

.table-warning {
    background-color: rgba(255, 193, 7, 0.1) !important;
}

.table-danger {
    background-color: rgba(220, 53, 69, 0.1) !important;
}

/* í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì•ˆë‚´ */
.card-body::after {
    content: "ğŸ’¡ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤: Ctrl+1(ì „ì²´ì¶œì„), Ctrl+2(ì „ì²´ì§€ê°), Ctrl+3(ì „ì²´ê²°ì„), Ctrl+R(ì´ˆê¸°í™”)";
    display: block;
    margin-top: 1rem;
    padding: 0.5rem;
    background: #e9ecef;
    border-radius: 4px;
    font-size: 0.8rem;
    color: #6c757d;
    text-align: center;
}
</style>
{% endblock %}